"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_utils=require("../../ui/src/utils"),_dom=require("../../ui/src/dom"),_util=require("../../date-panel/src/util"),_vn=require("../../ui/src/vn"),_log=require("../../ui/src/log"),_datePanel=_interopRequireDefault(require("../../date-panel/src/date-panel")),_button=_interopRequireDefault(require("../../button/src/button")),_buttonGroup=_interopRequireDefault(require("../../button/src/button-group"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_comp.defineVxeComponent)({name:"VxeDateRangePicker",props:{modelValue:[String,Number,Date,Array],startValue:[String,Number,Date],endValue:[String,Number,Date],immediate:{type:Boolean,default:!0},name:String,type:{type:String,default:"date"},clearable:{type:Boolean,default:()=>(0,_ui.getConfig)().dateRangePicker.clearable},readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},placeholder:String,autoComplete:{type:String,default:"off"},form:String,className:String,zIndex:Number,size:{type:String,default:()=>(0,_ui.getConfig)().dateRangePicker.size||(0,_ui.getConfig)().size},minDate:[String,Number,Date],maxDate:[String,Number,Date],defaultDate:[String,Number,Date,Array],defaultTime:[String,Number,Date,Array],startDay:{type:[String,Number],default:()=>(0,_ui.getConfig)().dateRangePicker.startDay},labelFormat:String,valueFormat:String,timeFormat:String,valueType:String,editable:{type:Boolean,default:!0},festivalMethod:{type:Function,default:()=>(0,_ui.getConfig)().dateRangePicker.festivalMethod},disabledMethod:{type:Function,default:()=>(0,_ui.getConfig)().dateRangePicker.disabledMethod},separator:{type:[String,Number],default:()=>(0,_ui.getConfig)().dateRangePicker.separator},selectDay:{type:[String,Number],default:()=>(0,_ui.getConfig)().dateRangePicker.selectDay},showClearButton:{type:Boolean,default:()=>(0,_ui.getConfig)().dateRangePicker.showClearButton},showConfirmButton:{type:Boolean,default:()=>(0,_ui.getConfig)().dateRangePicker.showConfirmButton},autoClose:{type:Boolean,default:()=>(0,_ui.getConfig)().dateRangePicker.autoClose},prefixIcon:String,suffixIcon:String,placement:String,transfer:{type:Boolean,default:null},shortcutConfig:Object},emits:["update:modelValue","update:startValue","update:endValue","input","change","keydown","keyup","click","focus","blur","clear","confirm","prefix-click","suffix-click","date-prev","date-today","date-next","shortcut-click"],setup(F,e){const{slots:T,emit:r}=e,c=(0,_vue.inject)("$xeModal",null),p=(0,_vue.inject)("$xeDrawer",null),D=(0,_vue.inject)("$xeTable",null),i=(0,_vue.inject)("$xeForm",null),n=(0,_vue.inject)("xeFormItemInfo",null);var a=_xeUtils.default.uniqueId();const A=(0,_ui.useSize)(F)["computeSize"],I=(0,_vue.reactive)({initialized:!1,panelIndex:0,visiblePanel:!1,isAniVisible:!1,panelStyle:{},panelPlacement:"",isActivated:!1,startValue:"",endValue:""}),o={},_=(0,_vue.ref)(),g=(0,_vue.ref)(),R=(0,_vue.ref)(),N=(0,_vue.ref)(),M=(0,_vue.ref)(),B=(0,_vue.ref)(),C={refElem:_,refInput:g},q={xID:a,props:F,context:e,reactData:I,internalData:o,getRefMaps:()=>C};const z=(0,_vue.computed)(()=>{var e=F["transfer"];if(null===e){var a=(0,_ui.getConfig)().dateRangePicker.transfer;if(_xeUtils.default.isBoolean(a))return a;if(D||c||p||i)return!0}return e}),f=(0,_vue.computed)(()=>{var e=F["readonly"];return null===e?!!i&&i.props.readonly:e}),b=(0,_vue.computed)(()=>{var e=F["disabled"];return null===e?!!i&&i.props.disabled:e}),$=(0,_vue.computed)(()=>{var e=F["defaultDate"];return e?_xeUtils.default.isArray(e)?e:-1<(""+e).indexOf(",")?(""+e).split(","):[e,e]:[]}),K=(0,_vue.computed)(()=>{var e=F["defaultTime"];return e?_xeUtils.default.isArray(e)?e:-1<(""+e).indexOf(",")?(""+e).split(","):[e,e]:[]});a=(0,_vue.computed)(()=>{var{startValue:e,endValue:a}=F;return""+(e||"")+(a||"")});const G=(0,_vue.computed)(()=>{var e=F["type"];return"time"===e||"datetime"===e}),s=(0,_vue.computed)(()=>-1<["date","week","month","quarter","year"].indexOf(F.type)),j=(0,_vue.computed)(()=>F.clearable),E=(0,_vue.computed)(()=>{var e=F["placeholder"];return(e=e||(0,_ui.getConfig)().dateRangePicker.placeholder)?(0,_utils.getFuncText)(e):(0,_ui.getI18n)("vxe.dateRangePicker.pleaseRange")}),l=(0,_vue.computed)(()=>{var e=F["immediate"];return e}),U=(0,_vue.computed)(()=>Object.assign({},(0,_ui.getConfig)().dateRangePicker.shortcutConfig,F.shortcutConfig)),O=(0,_vue.computed)(()=>{var e=U.value["options"];return e?e.map((e,a)=>Object.assign({name:""+(e.name||e.code||a)},e)):[]}),P=(0,_vue.computed)(()=>{var e=F["labelFormat"];return e||(0,_ui.getI18n)("vxe.input.date.labelFormat."+F.type)}),m=(0,_vue.computed)(()=>{var{type:e,valueFormat:a}=F;return(0,_util.handleValueFormat)(e,a)}),y=(0,_vue.computed)(()=>{var e=F["startDay"];return _xeUtils.default.toNumber(e)}),Y=(0,_vue.computed)(()=>{var{startValue:e,endValue:a}=I,e=e||a?[e||"",a||""]:[];return w(e)}),S=(0,_vue.computed)(()=>{return Y.value.label}),w=e=>{var{type:a,separator:t}=F,l=P.value,u=m.value,r=y.value,i=e[0]?(0,_util.parseDateObj)(e[0],a,{valueFormat:u,labelFormat:l,firstDay:r}):null,e=e[1]?(0,_util.parseDateObj)(e[1],a,{valueFormat:u,labelFormat:l,firstDay:r}):null,a=i?i.label:"",u=e?e.label:"";return{label:(a||u?[a,u]:[]).join(""+(t||" ~ ")),startLabel:a,endLabel:u}},h=(e,a)=>{var{modelValue:t,valueType:l}=F;let u=_xeUtils.default.isArray(t);if(l)switch(l){case"array":u=!0;break;case"string":u=!1}return e||a?(t=[e||"",a||""],u?t:t.join(",")):u?[]:""},Z=()=>{var e,{type:a,modelValue:t}=F,l=m.value;let u="",r="";return _xeUtils.default.isArray(t)?(e=(0,_util.parseDateString)(t[0],a,{valueFormat:l}),a=(0,_util.parseDateString)(t[1],a,{valueFormat:l}),(e||a)&&(u=e||"",r=a||"")):_xeUtils.default.isString(t)&&((l=t.split(","))[0]||l[1])&&(u=l[0]||"",r=l[1]||""),{sValue:u,eValue:r}},H=()=>{var{type:e,startValue:a,endValue:t}=F,l=m.value;return{sValue:(0,_util.parseDateString)(a,e,{valueFormat:l}),eValue:(0,_util.parseDateString)(t,e,{valueFormat:l})}},t=e=>{var{modelValue:a,startValue:t,endValue:l}=F;let u={sValue:"",eValue:""};u=(e?a?Z:H:t||l?H:Z)(),I.startValue=u.sValue,I.endValue=u.eValue},u=e=>{var{startValue:a,endValue:t}=I,l=h(a,t);k(e.type,{value:l,startValue:a,endValue:t},e)},x=(e,a,t)=>{var l=F["modelValue"],u=(I.startValue=e,I.endValue=a,h(e,a));r("update:modelValue",u),r("update:startValue",e||""),r("update:endValue",a||""),_xeUtils.default.toValueString(l)!==u&&(k("change",{value:u},t),i)&&n&&i.triggerItemEvent(t,n.itemConfig.field,u)},J=e=>{l.value||u(e)},Q=e=>{I.isActivated=!0,me(e),u(e)},W=e=>{var a,t,l;b.value||({startValue:a,endValue:t}=I,l=h(a,t),k("prefix-click",{value:l,startValue:a,endValue:t},e))},V=()=>new Promise(e=>{I.visiblePanel=!1,o.hpTimeout=setTimeout(()=>{I.isAniVisible=!1,e()},350)}),X=(e,a)=>{s.value&&V();x("","",e),k("clear",{value:a,startValue:"",endValue:""},e)},d=()=>{var e=M.value,a=B.value;e&&a&&(e=e.getModelValue(),a=a.getModelValue(),e&&a||x("","",{type:"check"}))},ee=()=>{var e=F["autoClose"],{startValue:a,endValue:t}=I,l=o["selectStatus"],u=s.value;e?l&&u&&a&&t&&V():a&&t&&(o.selectStatus=!1)},ae=e=>{var a,t,l;b.value||({startValue:a,endValue:t}=I,l=h(a,t),k("suffix-click",{value:l,startValue:a,endValue:t},e))},te=e=>{var{startValue:a,endValue:t}=I;l.value||x(a,t,e),I.visiblePanel||(I.isActivated=!1),k("blur",{value:"",startValue:a,endValue:t},e),i&&n&&i.triggerItemEvent(e,n.itemConfig.field,"")},le=e=>{u(e)},ue=e=>{u(e)},re=e=>{var a,t,l=M.value,u=B.value;l&&u&&(a=l.getModelValue(),t=u.getModelValue(),a&&!t||!a&&t?x("","",e):(l.confirmByEvent(e),u.confirmByEvent(e)),l=h(a,t),k("confirm",{value:l,startValue:a,endValue:t},e)),V()},ie=e=>{var a=o["selectStatus"],{value:e,$event:t}=e;const l=a?I.endValue:"";x(e,l,t),ee(),a||(o.selectStatus=!0),(0,_vue.nextTick)(()=>{var e=M.value,a=B.value;e&&a&&(e=e.getModelValue(),!l)&&e&&a.setPanelDate(_xeUtils.default.toStringDate(e))})},ne=e=>{var a=o["selectStatus"],{value:e,$event:t}=e;const l=a?I.startValue:"";x(l,e,t),ee(),a||(o.selectStatus=!0),(0,_vue.nextTick)(()=>{var e=M.value,a=B.value;e&&a&&(a=a.getModelValue(),!l)&&a&&e.setPanelDate(_xeUtils.default.toStringDate(a))})},oe=e=>{var{visiblePanel:a,isActivated:t}=I,l=_.value,u=N.value;!b.value&&t&&(I.isActivated=(0,_dom.getEventTargetNode)(e,l).flag||(0,_dom.getEventTargetNode)(e,u).flag,I.isActivated||a&&(d(),V()))},se=e=>{var a,t=I["visiblePanel"];b.value||(a=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.TAB),e=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ESCAPE),a&&(I.isActivated=!1),t&&(e||a)&&V())},de=e=>{var a=I["visiblePanel"];b.value||a&&(a=N.value,((0,_dom.getEventTargetNode)(e,a).flag?v:V)())},ve=()=>{var{visiblePanel:e,isActivated:a}=I;e&&V(),a&&(I.isActivated=!1),(e||a)&&(e=g.value)&&e.blur()},ce=()=>{var e=I["visiblePanel"];e&&v()},v=()=>{const t=F["placement"],l=I["panelIndex"],u=g.value,r=R.value,i=z.value;var e=()=>{var e=(0,_dom.updatePanelPlacement)(u,r,{placement:t,teleportTo:i}),a=Object.assign(e.style,{zIndex:l});I.panelStyle=a,I.panelPlacement=e.placement};return e(),(0,_vue.nextTick)().then(e)},pe=()=>{var e=I["visiblePanel"];return(b.value||e?(0,_vue.nextTick):(I.initialized||(I.initialized=!0),o.hpTimeout&&(clearTimeout(o.hpTimeout),o.hpTimeout=void 0),o.selectStatus=!1,I.isActivated=!0,I.isAniVisible=!0,setTimeout(()=>{I.visiblePanel=!0},10),(e=F.zIndex)?I.panelIndex=e:I.panelIndex<(0,_utils.getLastZIndex)()&&(I.panelIndex=(0,_utils.nextZIndex)()),v))()},me=e=>{f.value||(e.preventDefault(),pe())},_e=e=>{u(e)},ge=({option:e,$event:a})=>{var t=F["type"],l=U.value,u=l["autoClose"],{code:r,clickMethod:i}=e,n=I.startValue,o=I.endValue,s=h(n,o),d={$dateRangePicker:q,option:e,value:s,startValue:n,endValue:o,code:r};if(!i&&r){e=_ui.commands.get(r),e=e?e.dateRangePickerCommandMethod:null;if(e)e(d);else{var v=m.value,c=y.value;switch(r){case"last1":case"last3":case"last7":case"last30":case"last60":case"last90":case"last180":var p=(0,_util.getRangeDateByCode)(r,s,t,{valueFormat:v,firstDay:c}),n=p.startValue,o=p.endValue,s=h(n,o);d.value=s,d.startValue=n,d.endValue=o,x(n,o,a);break;default:(0,_log.errLog)("vxe.error.notCommands",["[date-range-picker] "+r])}}}else{e=i||l.clickMethod;e&&e(d)}u&&V(),k("shortcut-click",d,a)},k=(e,a,t)=>{r(e,(0,_ui.createEvent)(t,{$dateRangePicker:q},a))},L=(e={dispatchEvent:k,setModelValue(e,a){I.startValue=e||"",I.endValue=a||"";e=h(e,a);r("update:modelValue",e)},setModelValueByEvent(e,a,t){x(a||"",t||"",e)},focus(){var e=g.value;return I.isActivated=!0,e.focus(),(0,_vue.nextTick)()},blur(){return g.value.blur(),(I.isActivated=!1,_vue.nextTick)()},select(){return g.value.select(),(I.isActivated=!1,_vue.nextTick)()},showPanel:pe,hidePanel:V,updatePlacement:v},Object.assign(q,e),(e,a)=>{var t=U.value,{position:l,align:u,mode:r}=t,i=O.value;return(0,_utils.isEnableConf)(t)&&i.length&&(l||"left")===e?(0,_vue.h)("div",{class:`vxe-date-range-picker--layout-${e}-wrapper`},[(0,_vue.h)(_buttonGroup.default,{options:i,mode:r,align:u,vertical:a,onClick:ge})]):(0,_ui.renderEmptyElement)(q)}),fe=()=>(0,_vue.h)("div",{class:"vxe-date-range-picker--control-icon",onClick:me},[(0,_vue.h)("i",{class:["vxe-date-range-picker--date-picker-icon",(0,_ui.getIcon)().DATE_PICKER_DATE]})]);return(0,_vue.watch)(()=>F.modelValue,()=>{t(!0)}),(0,_vue.watch)(a,()=>{t(!1)}),t(!0),(0,_vue.nextTick)(()=>{_ui.globalEvents.on(q,"mousewheel",de),_ui.globalEvents.on(q,"mousedown",oe),_ui.globalEvents.on(q,"keydown",se),_ui.globalEvents.on(q,"blur",ve),_ui.globalEvents.on(q,"resize",ce)}),(0,_vue.onDeactivated)(()=>{d()}),(0,_vue.onUnmounted)(()=>{_ui.globalEvents.off(q,"mousewheel"),_ui.globalEvents.off(q,"mousedown"),_ui.globalEvents.off(q,"blur"),_ui.globalEvents.off(q,"resize")}),(0,_vue.onBeforeUnmount)(()=>{d()}),(0,_vue.provide)("$xeDateRangePicker",q),q.renderVN=()=>{var e,a,t,{className:l,type:u,name:r,autoComplete:i}=F,{startValue:n,endValue:o,visiblePanel:s,isActivated:d}=I,v=A.value,c=b.value,p=f.value,m=S.value;return p?(0,_vue.h)("div",{ref:_,class:["vxe-date-range-picker--readonly","type--"+u,l]},m):(p=E.value,e=j.value,t=F.prefixIcon,a=(a=T.prefix)||t?(0,_vue.h)("div",{class:"vxe-date-range-picker--prefix",onClick:W},[(0,_vue.h)("div",{class:"vxe-date-range-picker--prefix-icon"},a?(0,_vn.getSlotVNs)(a({})):[(0,_vue.h)("i",{class:t})])]):null,t=(()=>{var e=F["suffixIcon"],{startValue:a,endValue:t}=I,l=T.suffix,u=b.value,r=j.value;return(0,_vue.h)("div",{class:["vxe-date-range-picker--suffix",{"is--clear":r&&!u&&(a||t)}]},[r?(0,_vue.h)("div",{class:"vxe-date-range-picker--clear-icon",onClick:X},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().INPUT_CLEAR})]):(0,_ui.renderEmptyElement)(q),fe(),l||e?(0,_vue.h)("div",{class:"vxe-date-range-picker--suffix-icon",onClick:ae},l?(0,_vn.getSlotVNs)(l({})):[(0,_vue.h)("i",{class:e})]):(0,_ui.renderEmptyElement)(q)])})(),(0,_vue.h)("div",{ref:_,class:["vxe-date-range-picker","type--"+u,l,{["size--"+v]:v,"is--prefix":!!a,"is--suffix":!!t,"is--visible":s,"is--disabled":c,"is--active":d,"show--clear":e&&!c&&(n||o)}],spellcheck:!1},[a||(0,_ui.renderEmptyElement)(q),(0,_vue.h)("div",{class:"vxe-date-range-picker--wrapper"},[(0,_vue.h)("input",{ref:g,class:"vxe-date-range-picker--inner",value:m,name:r,type:"text",placeholder:p,readonly:!0,disabled:c,autocomplete:i,onKeydown:le,onKeyup:ue,onClick:_e,onChange:J,onFocus:Q,onBlur:te})]),t||(0,_ui.renderEmptyElement)(q),(()=>{var{type:e,separator:a,autoClose:t,showConfirmButton:l,showClearButton:u}=F,{initialized:r,isAniVisible:i,visiblePanel:n,panelPlacement:o,panelStyle:s,startValue:d,endValue:v}=I,c=A.value,p=z.value,m=U.value,_=j.value,g=Y.value,f=O.value,b=G.value,y=$.value,h=K.value,{startLabel:g,endLabel:x}=g,m=m["position"],V=T.header,k=T.footer,D=T.top,C=T.bottom,E=T.left,P=T.right,[y,S]=y,[h,w]=h,f=0<f.length,b=null===l?b||!t:l,t=null===u?_:u;return(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!p||!r},[(0,_vue.h)("div",{ref:R,class:["vxe-table--ignore-clear vxe-date-range-picker--panel","type--"+e,{["size--"+c]:c,"is--transfer":p,"ani--leave":i,"ani--enter":n,"show--top":!!(D||V||f&&("top"===m||"header"===m)),"show--bottom":!!(C||k||f&&("bottom"===m||"footer"===m)),"show--left":!!(E||f&&"left"===m),"show--right":!!(P||f&&"right"===m)}],placement:o,style:s},r&&(n||i)?[(0,_vue.h)("div",{ref:N,class:["vxe-date-range-picker--layout-all-wrapper","type--"+e,{["size--"+c]:c}]},[D?(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-top-wrapper"},D({})):L("top"),(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-body-layout-wrapper"},[E?(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-left-wrapper"},E({})):L("left",!0),(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-body-content-wrapper"},[V?(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-header-wrapper"},V({})):L("header"),(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-body-wrapper"},[(0,_vue.h)(_datePanel.default,{ref:M,modelValue:d,type:F.type,className:F.className,minDate:F.minDate,maxDate:F.maxDate,endDate:v,startDay:F.startDay,labelFormat:F.labelFormat,valueFormat:F.valueFormat,timeFormat:F.timeFormat,defaultDate:y,defaultTime:h,festivalMethod:F.festivalMethod,disabledMethod:F.disabledMethod,selectDay:F.selectDay,onChange:ie}),(0,_vue.h)(_datePanel.default,{ref:B,modelValue:v,type:F.type,className:F.className,minDate:F.minDate,maxDate:F.maxDate,startDate:d,startDay:F.startDay,labelFormat:F.labelFormat,valueFormat:F.valueFormat,timeFormat:F.timeFormat,defaultDate:S,defaultTime:w,festivalMethod:F.festivalMethod,disabledMethod:F.disabledMethod,selectDay:F.selectDay,onChange:ne})]),(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-footer-wrapper"},[(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-footer-label"},g||x?[(0,_vue.h)("span",g),(0,_vue.h)("span",""+(a||"")),(0,_vue.h)("span",x)]:[]),(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-footer-custom"},k?k({}):[L("footer")]),(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-footer-btns"},[t?(0,_vue.h)(_button.default,{size:"mini",disabled:!(d||v),content:(0,_ui.getI18n)("vxe.button.clear"),onClick:X}):(0,_ui.renderEmptyElement)(q),b?(0,_vue.h)(_button.default,{size:"mini",status:"primary",content:(0,_ui.getI18n)("vxe.button.confirm"),onClick:re}):(0,_ui.renderEmptyElement)(q)])])]),P?(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-right-wrapper"},P({})):L("right",!0)]),C?(0,_vue.h)("div",{class:"vxe-date-range-picker--layout-bottom-wrapper"},C({})):L("bottom")])]:[])])})()]))},q},render(){return this.renderVN()}});