"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_utils=require("../../ui/src/utils"),_dom=require("../../ui/src/dom"),_vn=require("../../ui/src/vn"),_util=require("./util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_comp.defineVxeComponent)({name:"VxeNumberInput",props:{modelValue:[String,Number],immediate:{type:Boolean,default:!0},name:String,type:{type:String,default:"number"},clearable:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.clearable},readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},placeholder:String,maxLength:{type:[String,Number],default:()=>(0,_ui.getConfig)().numberInput.maxLength},autoComplete:{type:String,default:"off"},align:String,form:String,className:String,size:{type:String,default:()=>(0,_ui.getConfig)().numberInput.size||(0,_ui.getConfig)().size},min:{type:[String,Number],default:null},max:{type:[String,Number],default:null},step:[String,Number],exponential:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.exponential},showCurrency:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.showCurrency},currencySymbol:{type:String,default:()=>(0,_ui.getConfig)().numberInput.currencySymbol},controlConfig:Object,digits:{type:[String,Number],default:null},autoFill:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.autoFill},editable:{type:Boolean,default:!0},plusIcon:String,minusIcon:String,prefixIcon:String,suffixIcon:String,controls:{type:Boolean,default:null},maxlength:[String,Number],autocomplete:String},emits:["update:modelValue","input","change","keydown","keyup","wheel","click","focus","blur","clear","lazy-change","plus-number","minus-number","prefix-click","suffix-click","prev-number","next-number"],setup(b,e){const{slots:g,emit:a}=e,i=(0,_vue.inject)("$xeForm",null),n=(0,_vue.inject)("xeFormItemInfo",null);var t=_xeUtils.default.uniqueId();const K=(0,_ui.useSize)(b)["computeSize"],x=(0,_vue.reactive)({isFocus:!1,isActivated:!1,inputValue:b.modelValue}),r={},y=(0,_vue.ref)(),p=(0,_vue.ref)(),q=(0,_vue.ref)(),h=(0,_vue.computed)(()=>{var e=b["readonly"];return null===e?!!i&&i.props.readonly:e}),E=(0,_vue.computed)(()=>{var e=b["disabled"];return null===e?!!i&&i.props.disabled:e}),o=(0,_vue.computed)(()=>{var{type:e,digits:t}=b;let u=t;return null===u&&null===(u=(0,_ui.getConfig)().numberInput.digits)&&"amount"===e&&(u=2),_xeUtils.default.toInteger(u)||1}),N=(0,_vue.computed)(()=>Object.assign({},(0,_ui.getConfig)().numberInput.controlConfig,b.controlConfig)),s=(0,_vue.computed)(()=>{var e=b["type"];return"float"===e||"amount"===e}),O=(0,_vue.computed)(()=>{var e=b["type"],t=o.value,u=s.value,l=b.step;return"integer"===e?_xeUtils.default.toInteger(l)||1:u?_xeUtils.default.toNumber(l)||1/Math.pow(10,t):_xeUtils.default.toNumber(l)||1}),V=(0,_vue.computed)(()=>b.clearable),U=(0,_vue.computed)(()=>{var e=b["editable"];return h.value||!e}),R=(0,_vue.computed)(()=>{var e=b["placeholder"];return(e=e||(0,_ui.getConfig)().numberInput.placeholder)?(0,_utils.getFuncText)(e):(0,_ui.getI18n)("vxe.base.pleaseInput")}),d=(0,_vue.computed)(()=>{var{maxLength:e,maxlength:t}=b;return _xeUtils.default.toNumber(e||t)||16}),v=(0,_vue.computed)(()=>{var e=b["immediate"];return e}),l=(0,_vue.computed)(()=>{var e=b["type"],t=x["inputValue"];return"integer"===e?_xeUtils.default.toInteger((0,_util.handleNumber)(t)):_xeUtils.default.toNumber((0,_util.handleNumber)(t))}),I=(0,_vue.computed)(()=>{var{type:t,showCurrency:u,currencySymbol:l,autoFill:a}=b,i=x["inputValue"],n=o.value;if("amount"!==t)return _xeUtils.default.toString(i);{var t=_xeUtils.default.toNumber(i);let e=_xeUtils.default.commafy(t,{digits:n});return a||([i,t]=e.split("."),t&&(n=t.replace(/0+$/,""),e=n?[i,".",n].join(""):i)),u?""+(l||(0,_ui.getI18n)("vxe.numberInput.currencySymbol")||"")+e:e}}),c=(0,_vue.computed)(()=>{var e=b["min"],t=x["inputValue"],u=l.value;return!(!t&&0!==t||null===e)&&u<=_xeUtils.default.toNumber(e)}),m=(0,_vue.computed)(()=>{var e=b["max"],t=x["inputValue"],u=l.value;return!(!t&&0!==t||null===e)&&u>=_xeUtils.default.toNumber(e)}),D={refElem:y,refInput:p},z={computeControlOpts:N},_={xID:t,props:b,context:e,reactData:x,internalData:r,getRefMaps:()=>D,getComputeMaps:()=>z};let f={};const C=e=>_xeUtils.default.eqNull(e)?"":""+e,S=e=>{var{exponential:t,autoFill:u}=b,l=d.value,a=o.value;let i="";return s.value?(i=(0,_util.toFloatValueFixed)(e,a),u||(i=C(_xeUtils.default.toNumber(i)))):i=C(e),!t||e!==i&&C(e).toLowerCase()!==_xeUtils.default.toNumber(i).toExponential()?i.slice(0,l):e},A=e=>{var t=x["inputValue"];f.dispatchEvent(e.type,{value:t},e)},T=(e,t,u)=>{var e=(0,_utils.eqEmptyValue)(e)?null:Number(e),l=e!==b.modelValue;l&&(r.isUM=!0,a("update:modelValue",e)),x.inputValue!==t&&(0,_vue.nextTick)(()=>{x.inputValue=t||""}),f.dispatchEvent("input",{value:e},u),l&&(f.dispatchEvent("change",{value:e},u),i)&&n&&i.triggerItemEvent(u,n.itemConfig.field,e)},k=(e,t)=>{var u=v.value,l=(0,_utils.eqEmptyValue)(e)?null:_xeUtils.default.toNumber(e);x.inputValue=e,u?T(l,e,t):f.dispatchEvent("input",{value:l},t)},P=e=>{var t=e.target.value;k(t,e)},Y=e=>{v.value||A(e),_.dispatchEvent("lazy-change",{value:x.inputValue},e)},j=e=>{var t;U.value||(t=x["inputValue"],x.inputValue=(0,_utils.eqEmptyValue)(t)?"":""+_xeUtils.default.toNumber(t),x.isFocus=!0,x.isActivated=!0,A(e))},G=e=>{var t;E.value||(t=x["inputValue"],f.dispatchEvent("prefix-click",{value:t},e))},w=(e,t)=>{focus(),T(null,"",e),f.dispatchEvent("clear",{value:t},e),_.dispatchEvent("lazy-change",{value:t},e)},W=e=>{var t;E.value||(t=x["inputValue"],f.dispatchEvent("suffix-click",{value:t},e))},$=()=>{var u=b["autoFill"],l=x["inputValue"],a=o.value,e=s.value;if(e&&l){let e="",t=null;l&&(e=(0,_util.toFloatValueFixed)(l,a),t=_xeUtils.default.toNumber(e),u||(e=""+t)),l!==t?T(t,e,{type:"init"}):x.inputValue=e}},H=e=>null===b.max||""===b.max||_xeUtils.default.toNumber(e)<=_xeUtils.default.toNumber(b.max),J=e=>null===b.min||""===b.min||_xeUtils.default.toNumber(e)>=_xeUtils.default.toNumber(b.min),L=()=>{var{type:t,min:u,max:l,exponential:a}=b,i=x["inputValue"];if(!U.value)if((0,_utils.eqEmptyValue)(i)){let e=null,t=i;!u&&0!==u||(e=_xeUtils.default.toNumber(u),t=""+e),void T(e,""+(t||""),{type:"check"})}else if(i||u||l){let e="integer"===t?_xeUtils.default.toInteger((0,_util.handleNumber)(i)):_xeUtils.default.toNumber((0,_util.handleNumber)(i));J(e)?H(e)||(e=l):e=u,a&&(t=C(i).toLowerCase())===_xeUtils.default.toNumber(e).toExponential()&&(e=t);l=S(e);T((0,_utils.eqEmptyValue)(l)?null:Number(l),l,{type:"check"})}},Q=e=>{var t=x["inputValue"],u=v.value,l=t?Number(t):null;u||T(l,C(t),e),L(),x.isFocus=!1,x.isActivated=!1,f.dispatchEvent("blur",{value:l},e),i&&n&&i.triggerItemEvent(e,n.itemConfig.field,l)},X=(e,t)=>{var{min:u,max:l,type:a}=b,i=x["inputValue"],n=O.value,a="integer"===a?_xeUtils.default.toInteger((0,_util.handleNumber)(i)):_xeUtils.default.toNumber((0,_util.handleNumber)(i)),i=e?_xeUtils.default.add(a,n):_xeUtils.default.subtract(a,n);let r;r=J(i)?H(i)?i:l:u,k(S(r),t)},B=e=>{var t=E.value,u=h.value,l=m.value;t||u||l||X(!0,e),x.isActivated=!0,f.dispatchEvent("plus-number",{value:x.inputValue},e),_.dispatchEvent("lazy-change",{value:x.inputValue},e),f.dispatchEvent("next-number",{value:x.inputValue},e)},M=e=>{var t=E.value,u=h.value,l=c.value;t||u||l||X(!1,e),x.isActivated=!0,f.dispatchEvent("minus-number",{value:x.inputValue},e),_.dispatchEvent("lazy-change",{value:x.inputValue},e),f.dispatchEvent("prev-number",{value:x.inputValue},e)},Z=e=>{var{type:t,exponential:u,controls:l}=b,a=N.value,i=a["isArrow"],n=U.value,r=(0,_dom.hasControlKey)(e),o=e.shiftKey,s=e.altKey,v=e.keyCode,p=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ESCAPE),d=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),c=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN);r||o||s||(_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.SPACEBAR)||"integer"===t&&110===v||(!u||69!==v)&&65<=v&&v<=90||186<=v&&v<=188||191<=v)&&e.preventDefault(),p?L():(d||c)&&(0,_utils.isEnableConf)(a)&&(!1===l?l:i)&&!n&&(r=e,o=_ui.globalEvents.hasKey(r,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),s=_ui.globalEvents.hasKey(r,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN),o||s)&&(r.preventDefault(),(o?B:M)(r)),A(e)},ee=e=>{A(e)},te=e=>{u(),r.ainTimeout=setTimeout(()=>{M(e),te(e)},60)},ue=e=>{u(),r.ainTimeout=setTimeout(()=>{B(e),ue(e)},60)},u=()=>{var e;(e=r.dnTimeout)&&(clearTimeout(e),r.dnTimeout=void 0),(e=r.ainTimeout)&&(clearTimeout(e),r.ainTimeout=void 0)},le=e=>{r.isMouseDown?r.isMouseDown=!1:(u(),((0,_dom.hasClass)(e.currentTarget,"is--plus")?B:M)(e))},ae=e=>{if(u(),r.isMouseDown=!0,0===e.button){const t=(0,_dom.hasClass)(e.currentTarget,"is--plus");(t?B:M)(e),r.dnTimeout=setTimeout(()=>{(t?ue:te)(e)},500)}},ie=e=>{var t=b["controls"],u=N.value,l=u["isWheel"],a=U.value;(0,_utils.isEnableConf)(u)&&(!1===t?t:l)&&!a&&x.isActivated&&(e.stopPropagation(),e.preventDefault(),0<(u=e.deltaY)?M(e):u<0&&B(e)),A(e)},ne=e=>{A(e)},re=e=>{var t=x["isActivated"],u=y.value,l=q.value,a=E.value,i=U.value,n=v.value;a||i||!t||(x.isActivated=(0,_dom.getEventTargetNode)(e,u).flag||(0,_dom.getEventTargetNode)(e,l).flag,x.isActivated)||(n||(a=x["inputValue"],i=a?Number(a):null,T(i,C(a),e)),L())},oe=t=>{var u=b["clearable"],l=E.value,a=U.value;if(!l&&!a){l=_ui.globalEvents.hasKey(t,_ui.GLOBAL_EVENT_KEYS.TAB),a=_ui.globalEvents.hasKey(t,_ui.GLOBAL_EVENT_KEYS.DELETE);let e=x.isActivated;l&&(e&&L(),e=!1,x.isActivated=e),a&&u&&e&&w(t,null)}},se=()=>{var e=x["isActivated"];e&&L()};f={dispatchEvent:(e,t,u)=>{a(e,(0,_ui.createEvent)(u,{$numberInput:_},t))},focus(){var e;return U.value||(e=p.value,x.isActivated=!0,e.focus()),(0,_vue.nextTick)()},blur(){return p.value.blur(),(x.isActivated=!1,_vue.nextTick)()},select(){return p.value.select(),(x.isActivated=!1,_vue.nextTick)()}},Object.assign(_,f);const ve=()=>{var e=b["prefixIcon"],t=g.prefix;return t||e?(0,_vue.h)("div",{class:"vxe-number-input--prefix",onClick:G},[(0,_vue.h)("div",{class:"vxe-number-input--prefix-icon"},t?(0,_vn.getSlotVNs)(t({})):[(0,_vue.h)("i",{class:e})])]):(0,_ui.renderEmptyElement)(_)},pe=()=>{var e=b["suffixIcon"],t=x["inputValue"],u=g.suffix,l=E.value,a=V.value;return(0,_vue.h)("div",{class:["vxe-number-input--suffix",{"is--clear":a&&!l&&!(""===t||_xeUtils.default.eqNull(t))}]},[a?(0,_vue.h)("div",{class:"vxe-number-input--clear-icon",onClick:w},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().INPUT_CLEAR})]):(0,_ui.renderEmptyElement)(_),u||e?(0,_vue.h)("div",{class:"vxe-number-input--suffix-icon",onClick:W},u?(0,_vn.getSlotVNs)(u({})):[(0,_vue.h)("i",{class:e})]):(0,_ui.renderEmptyElement)(_)])},F=()=>{var{type:e,name:t,autocomplete:u,autoComplete:l}=b,{inputValue:a,isFocus:i}=x,n=E.value,r=I.value,o=U.value,s=d.value,v=R.value;return(0,_vue.h)("div",{key:"ni",class:"vxe-number-input--input-wrapper"},[ve(),(0,_vue.h)("div",{class:"vxe-number-input--input-inner"},[(0,_vue.h)("input",{ref:p,class:"vxe-number-input--input",value:i||"amount"!==e?a:r,name:t,type:"text",placeholder:v,maxlength:s,readonly:o,disabled:n,autocomplete:l||u,onKeydown:Z,onKeyup:ee,onClick:ne,onInput:P,onChange:Y,onFocus:j,onBlur:Q})]),pe()])},de=()=>{var e=b["minusIcon"],t=c.value;return(0,_vue.h)("button",{key:"prev",class:["vxe-number-input--minus-btn is--minus",{"is--disabled":t}],type:"button",onClick:le,onMousedown:ae,onMouseup:u,onMouseleave:u},[(0,_vue.h)("i",{class:e||(0,_ui.getIcon)().NUMBER_INPUT_MINUS_NUM})])},ce=()=>{var e=b["plusIcon"],t=m.value;return(0,_vue.h)("button",{key:"next",class:["vxe-number-input--plus-btn is--plus",{"is--disabled":t}],type:"button",onClick:le,onMousedown:ae,onMouseup:u,onMouseleave:u},[(0,_vue.h)("i",{class:e||(0,_ui.getIcon)().NUMBER_INPUT_PLUS_NUM})])},me=()=>(0,_vue.h)("div",{key:"cplr",class:"vxe-number-input--side-control"},[ce(),de()]);return _.renderVN=()=>{var{className:e,controls:t,type:u,align:l,prefixIcon:a,suffixIcon:i}=b,{inputValue:n,isActivated:r}=x,o=K.value,s=N.value,{layout:v,showButton:p}=s,d=E.value,c=h.value,m=I.value,_=g.prefix,f=g.suffix;return c?(0,_vue.h)("div",{ref:y,class:["vxe-number-input--readonly","type--"+u,e]},m):(c=U.value,m=V.value,s=(0,_utils.isEnableConf)(s)&&(!1===t?t:p),(0,_vue.h)("div",{ref:y,class:["vxe-number-input","type--"+u,"ctl--"+("right"===v||"left"===v?v:"default"),e,{["size--"+o]:o,["is--"+l]:l,"is--controls":s&&!c,"is--prefix":!!_||a,"is--suffix":!!f||i,"is--disabled":d,"is--active":r,"show--clear":m&&!d&&!(""===n||_xeUtils.default.eqNull(n))}],spellcheck:!1},s?"right"===v?[F(),me()]:"left"===v?[me(),F()]:[de(),F(),ce()]:[F()]))},(0,_vue.watch)(()=>b.modelValue,t=>{if(!r.isUM){var u=b["autoFill"],l=x["inputValue"],a=o.value,i=s.value;if((0,_utils.eqEmptyValue)(t))x.inputValue="";else{let e=""+t;i&&(e=(0,_util.toFloatValueFixed)(t,a),u||(e=""+_xeUtils.default.toNumber(e))),e!==l&&(x.inputValue=e)}}r.isUM=!1}),(0,_vue.watch)(()=>b.type,()=>{Object.assign(x,{inputValue:b.modelValue}),$()}),(0,_vue.onMounted)(()=>{var e=p.value;e&&e.addEventListener("wheel",ie,{passive:!1}),_ui.globalEvents.on(_,"mousedown",re),_ui.globalEvents.on(_,"keydown",oe),_ui.globalEvents.on(_,"blur",se)}),(0,_vue.onBeforeUnmount)(()=>{x.isFocus=!1,u(),L();var e=p.value;e&&e.removeEventListener("wheel",ie),_ui.globalEvents.off(_,"mousedown"),_ui.globalEvents.off(_,"keydown"),_ui.globalEvents.off(_,"blur")}),$(),_},render(){return this.renderVN()}});