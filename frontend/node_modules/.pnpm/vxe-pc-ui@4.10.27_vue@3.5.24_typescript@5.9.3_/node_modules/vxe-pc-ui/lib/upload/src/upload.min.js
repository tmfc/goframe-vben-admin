"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_vn=require("../../ui/src/vn"),_log=require("../../ui/src/log"),_dom=require("../../ui/src/dom"),_util=require("./util"),_button=_interopRequireDefault(require("../../button/src/button"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_comp.defineVxeComponent)({name:"VxeUpload",props:{modelValue:[Array,String,Object],showList:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showList},moreConfig:Object,readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},autoSubmit:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.autoSubmit},mode:{type:String,default:()=>(0,_ui.getConfig)().upload.mode},imageTypes:{type:Array,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.imageTypes,!0)},imageConfig:{type:Object,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.imageConfig,!0)},imageStyle:{type:Object,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.imageStyle,!0)},fileTypes:{type:Array,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.fileTypes,!0)},dragSort:Boolean,dragToUpload:{type:Boolean,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.dragToUpload,!0)},pasteToUpload:{type:Boolean,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.pasteToUpload,!0)},keyField:String,singleMode:Boolean,urlMode:Boolean,urlArgs:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.urlArgs},multiple:Boolean,limitSize:{type:[String,Number],default:()=>(0,_ui.getConfig)().upload.limitSize},showLimitSize:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showLimitSize},limitSizeText:{type:[String,Number,Function],default:()=>(0,_ui.getConfig)().upload.limitSizeText},limitCount:{type:[String,Number],default:()=>(0,_ui.getConfig)().upload.limitCount},showLimitCount:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showLimitCount},limitCountText:{type:[String,Number,Function],default:()=>(0,_ui.getConfig)().upload.limitCountText},nameField:{type:String,default:()=>(0,_ui.getConfig)().upload.nameField},typeField:{type:String,default:()=>(0,_ui.getConfig)().upload.typeField},urlField:{type:String,default:()=>(0,_ui.getConfig)().upload.urlField},sizeField:{type:String,default:()=>(0,_ui.getConfig)().upload.sizeField},showErrorStatus:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showErrorStatus},showProgress:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showProgress},progressText:{type:[String,Number,Function],default:()=>(0,_ui.getConfig)().upload.progressText},showSubmitButton:Boolean,autoHiddenButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.autoHiddenButton},showUploadButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showUploadButton},buttonText:{type:[String,Number,Function],default:()=>(0,_ui.getConfig)().upload.buttonText},buttonIcon:{type:String,default:()=>(0,_ui.getConfig)().upload.buttonIcon},showButtonText:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showButtonText},showButtonIcon:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showButtonIcon},showRemoveButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showRemoveButton},showDownloadButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showDownloadButton},showPreview:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showPreview},showTip:{type:Boolean,default:()=>null},maxSimultaneousUploads:{type:Number,default:()=>(0,_ui.getConfig)().upload.maxSimultaneousUploads},tipText:[String,Number,Function],hintText:String,previewMethod:Function,uploadMethod:Function,beforeRemoveMethod:Function,removeMethod:Function,beforeDownloadMethod:Function,downloadMethod:Function,getUrlMethod:Function,getThumbnailUrlMethod:Function,size:{type:String,default:()=>(0,_ui.getConfig)().upload.size||(0,_ui.getConfig)().size}},emits:["update:modelValue","add","remove","remove-fail","download","download-fail","upload-success","upload-error","sort-dragend","more-visible"],setup(S,e){const{emit:u,slots:D}=e,U=(0,_vue.inject)("$xeForm",null),E=(0,_vue.inject)("xeFormItemInfo",null),i=(0,_vue.inject)("$xeTable",null);var t=_xeUtils.default.uniqueId();const b=(0,_ui.useSize)(S)["computeSize"],g=(0,_vue.ref)(),m=(0,_vue.ref)(),c=(0,_vue.ref)(),_=(0,_vue.ref)(),B=(0,_vue.reactive)({isDragUploadStatus:!1,showMorePopup:!1,isActivated:!1,fileList:[],fileCacheMaps:{},isDragMove:!1,dragIndex:-1,dragTipText:""}),r={moreId:_xeUtils.default.uniqueId("upload"),imagePreviewTypes:["jpg","jpeg","png","gif"],prevDragIndex:-1},l={refElem:g},L=(0,_vue.computed)(()=>{var e=S["readonly"];return null===e?!!U&&U.props.readonly:e}),P=(0,_vue.computed)(()=>{var e=S["disabled"];return null===e?!!U&&U.props.disabled:e}),M=(0,_vue.computed)(()=>S.keyField||"_X_KEY"),f=(0,_vue.computed)(()=>"image"===S.mode),V=(0,_vue.computed)(()=>S.nameField||"name"),A=(0,_vue.computed)(()=>S.typeField||"type"),T=(0,_vue.computed)(()=>S.urlField||"url"),F=(0,_vue.computed)(()=>S.sizeField||"size"),H=(0,_vue.computed)(()=>1024*_xeUtils.default.toNumber(S.limitSize)*1024),O=(0,_vue.computed)(()=>S.multiple?_xeUtils.default.toNumber(S.limitCount):1),C=(0,_vue.computed)(()=>{var e=S["multiple"],t=B["fileList"],o=O.value;return e?!o||t.length>=o:1<=t.length}),Y=(0,_vue.computed)(()=>{var e=_xeUtils.default.toNumber(S.limitSize);return e?1048576<e?e/1048576+"T":1024<e?e/1024+"G":e+"M":""}),Q=(0,_vue.computed)(()=>{var{showTip:e,tipText:t}=S;return _xeUtils.default.isBoolean(e)||(e=(0,_ui.getConfig)().upload.showTip,_xeUtils.default.isBoolean(e))?e:!!t}),X=(0,_vue.computed)(()=>{var{limitSize:e,fileTypes:t,multiple:o,limitCount:i}=S,l=S.tipText||S.hintText,a=f.value,u=Y.value;return _xeUtils.default.isString(l)?l:_xeUtils.default.isFunction(l)?""+l({}):(l=[],a?(o&&i&&l.push((0,_ui.getI18n)("vxe.upload.imgCountHint",[i])),e&&u&&l.push((0,_ui.getI18n)("vxe.upload.imgSizeHint",[u]))):(t&&t.length&&l.push((0,_ui.getI18n)("vxe.upload.fileTypeHint",[t.join("/")])),e&&u&&l.push((0,_ui.getI18n)("vxe.upload.fileSizeHint",[u])),o&&i&&l.push((0,_ui.getI18n)("vxe.upload.fileCountHint",[i]))),l.join((0,_ui.getI18n)("vxe.base.comma")))}),a=(0,_vue.computed)(()=>Object.assign({},S.imageConfig||S.imageStyle)),W=(0,_vue.computed)(()=>{var{width:e,height:t}=a.value,o={};return e&&(o.width=(0,_dom.toCssUnit)(e)),t&&(o.height=(0,_dom.toCssUnit)(t)),o}),K=(0,_vue.computed)(()=>Object.assign({showMoreButton:!0},S.moreConfig)),n={},N={xID:t,props:S,context:e,reactData:B,internalData:r,getRefMaps:()=>l,getComputeMaps:()=>n},z=()=>_xeUtils.default.uniqueId(),k=e=>{return e[M.value]},s=()=>{var{modelValue:e,multiple:t}=S,o=L.value;const l=M.value,a=V.value,u=A.value,n=T.value,r=F.value;e=e?(e?_xeUtils.default.isArray(e)?e:[e]:[]).map(e=>{if(!e||_xeUtils.default.isString(e)){var t=""+(e||""),o=_xeUtils.default.parseUrl(e);const i=(o?o.searchQuery[a]:"")||decodeURIComponent(""+(t||"")).split("/").pop()||"";return{[a]:i,[u]:(o?o.searchQuery[u]:"")||j(i),[n]:t,[r]:_xeUtils.default.toNumber(o?o.searchQuery[r]:0)||0,[l]:z()}}const i=e[a]||"";return e[a]=i,e[u]=e[u]||j(i),e[n]=e[n]||"",e[r]=e[r]||0,e[l]=e[l]||z(),e}):[];B.fileList=o||t?e:e.slice(0,1)},j=e=>{var t=e.lastIndexOf(".");return 0<t?e.substring(t+1).toLowerCase():""},R=(e,t,o)=>{u(e,(0,_ui.createEvent)(o,{$upload:N},t))},$=e=>{var{singleMode:t,urlArgs:o}=S;const i=T.value,l=V.value;let a=e?e.slice(0):[];o&&(a=a.map(e=>{var t=e[i];if(t){var o=_xeUtils.default.parseUrl(t);if(!o.searchQuery[l]&&-1===t.indexOf("blob:"))return""+t+(-1===t.indexOf("?")?"?":"&")+l+"="+encodeURIComponent(e[l]||"")}return t})),e=t?a[0]||null:a,u("update:modelValue",e)},q=e=>{var t=S.getUrlMethod||(0,_ui.getConfig)().upload.getUrlMethod,o=T.value;return t?t({$upload:N,option:e}):e[o]},J=t=>{var{imageTypes:e,showDownloadButton:o}=S;const i=A.value,l=S.beforeDownloadMethod||(0,_ui.getConfig)().upload.beforeDownloadMethod;var a=r["imagePreviewTypes"];a.concat(e||[]).some(e=>(""+e).toLowerCase()===(""+t[i]).toLowerCase())&&_ui.VxeUI.previewImage&&_ui.VxeUI.previewImage({urlList:[q(t)],showDownloadButton:o,beforeDownloadMethod:l?()=>l({$upload:N,option:t}):void 0})},G=(o,e)=>{const i=S["showErrorStatus"],l=k(o);var t=S.uploadMethod||(0,_ui.getConfig)().upload.uploadMethod;return t?Promise.resolve(t({$upload:N,file:e,option:o,updateProgress(e){var t=B["fileCacheMaps"],t=t[k(o)];t&&(t.percent=Math.max(0,Math.min(99,_xeUtils.default.toNumber(e))))}})).then(e=>{var t=B["fileCacheMaps"],t=t[l];t&&(t.percent=100,t.status="success"),Object.assign(o,e),R("upload-success",{option:o,data:e},null)}).catch(e=>{var t=B["fileCacheMaps"],t=t[l];t&&(t.status="error"),i?Object.assign(o,e):B.fileList=B.fileList.filter(e=>k(e)!==l),R("upload-error",{option:o,data:e},null)}).finally(()=>{var e=B["fileCacheMaps"],e=e[l];e&&(e.loading=!1)}):(t=B["fileCacheMaps"],(e=t[l])&&(e.loading=!1),Promise.resolve())},Z=e=>{const{uploadMethod:t,urlMode:o}=S;var i,l=B["fileCacheMaps"],l=l[k(e)];(t||(0,_ui.getConfig)().upload.uploadMethod)&&l&&(i=l.file,l.loading=!0,l.status="pending",l.percent=0,G(e,i).then(()=>{o&&$(B.fileList)}))},d=(t,o)=>{const{multiple:e,urlMode:i,showLimitSize:l,limitSizeText:a,showLimitCount:u,limitCountText:n,autoSubmit:r}=S;var s=B["fileList"];const d=S.uploadMethod||(0,_ui.getConfig)().upload.uploadMethod,p=M.value,v=V.value,g=A.value,m=T.value,c=F.value;var _=H.value;const f=O.value;var h=Y.value;let x=t;if(e&&f){if(u&&s.length>=f)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:n?""+(_xeUtils.default.isFunction(n)?n({maxCount:f}):n):(0,_ui.getI18n)("vxe.upload.overCountErr",[f])}));const b=x.length-(f-s.length);if(u&&0<b){const C=x.slice(f-s.length);n?_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:""+(_xeUtils.default.isFunction(n)?n({maxCount:f}):n)}):_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",width:null,slots:{default(){return(0,_vue.h)("div",{class:"vxe-upload--file-message-over-error"},[(0,_vue.h)("div",{},(0,_ui.getI18n)("vxe.upload.overCountExtraErr",[f,b])),(0,_vue.h)("div",{class:"vxe-upload--file-message-over-extra"},C.map((e,t)=>(0,_vue.h)("div",{key:t,class:"vxe-upload--file-message-over-extra-item"},e.name)))])}}})}x=x.slice(0,f-s.length)}if(l&&_)for(let e=0;e<t.length;e++)if(t[0].size>_)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:a?""+(_xeUtils.default.isFunction(a)?a({maxSize:_}):a):(0,_ui.getI18n)("vxe.upload.overSizeErr",[h])}));const w=Object.assign({},B.fileCacheMaps),y=e?s:[],I=[];x.forEach(e=>{var t=e["name"],o=z(),t={[v]:t,[g]:j(t),[c]:e.size,[m]:URL.createObjectURL(e),[p]:o},o=(d&&(w[o]={file:e,loading:!!r,status:"pending",percent:0}),(0,_vue.reactive)(t));d&&r&&I.push(G(o,e)),y.push(o)}),B.fileList=y,B.fileCacheMaps=w,y.forEach(e=>{R("add",{option:e},o)}),Promise.all(i?I:[]).then(()=>{$(y),U&&E&&U.triggerItemEvent(o,E.itemConfig.field,y)})},p=t=>{var{multiple:e,imageTypes:o,fileTypes:i}=S,l=P.value,a=f.value;return l?Promise.resolve({status:!1,files:[],file:null}):(0,_util.readLocalFile)({multiple:e,types:a?o:i}).then(e=>(d(e.files,t),e))},ee=e=>{p(e).catch(()=>{})},v=(e,t,o)=>{var i=B["fileList"];i.splice(o,1),$(i),U&&E&&U.triggerItemEvent(e,E.itemConfig.field,i),R("remove",{option:t},e)},te=(t,o,i)=>{var e=S.beforeRemoveMethod||(0,_ui.getConfig)().upload.beforeRemoveMethod;const l=S.removeMethod||(0,_ui.getConfig)().upload.removeMethod;Promise.resolve(!e||e({$upload:N,option:o})).then(e=>{e?l?Promise.resolve(l({$upload:N,option:o})).then(()=>{v(t,o,i)}).catch(e=>e):v(t,o,i):R("remove-fail",{option:o},t)})},oe=(e,t)=>{R("download",{option:t},e)},ie=e=>{var t,o,i,l=e.currentTarget,{clientX:e,clientY:a}=e;l&&({x:l,y:t,height:o,width:i}=l.getBoundingClientRect(),e<l||l+i<e||a<t||t+o<a)&&(B.isDragUploadStatus=!1)},le=e=>{var t=e.dataTransfer;t&&(t=t["items"],t)&&t.length&&(e.preventDefault(),B.isDragUploadStatus=!0)},ae=(e,t)=>{const{imageTypes:o,fileTypes:i}=S;var l=r["imagePreviewTypes"];if(f.value){const a=l.concat(o&&o.length?o:[]);t=t.filter(e=>{const t=(""+(e.type.split("/")[1]||"")).toLowerCase();return!!a.some(e=>(""+e).toLowerCase()===t)})}else if(i&&i.length){const u=[];if(t.forEach(e=>{const t=j(e.name);i.some(e=>(""+e).toLowerCase()===t)||u.push(t)}),u.length)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.message({content:(0,_ui.getI18n)("vxe.error.notType",[u.join(", ")]),status:"error"}))}t.length?d(t,e):_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:(0,_ui.getI18n)("vxe.upload.uploadTypeErr")})},ue=e=>{var t=e.dataTransfer;t&&(t=t["items"],t)&&t.length&&(e.preventDefault(),(t=ne(t)).length)&&ae(e,t),B.isDragUploadStatus=!1},ne=e=>{const t=[];return _xeUtils.default.arrayEach(e,e=>{e=e.getAsFile();e&&t.push(e)}),t},h=e=>{const p=L.value,v=f.value;e=e.$event;_ui.VxeUI.modal&&(_ui.VxeUI.modal.open({id:r.moreId,title:p?(0,_ui.getI18n)("vxe.upload.morePopup.readTitle"):(0,_ui.getI18n)("vxe.upload.morePopup."+(v?"imageTitle":"fileTitle")),width:660,height:500,escClosable:!0,showMaximize:!0,resize:!0,maskClosable:!0,slots:{default(){var{showErrorStatus:e,dragToUpload:t,dragSort:o}=S,{isActivated:i,isDragMove:l,isDragUploadStatus:a,dragIndex:u}=B;const n=B["fileList"];var r=P.value,s=D.moreContent||D["more-content"],d={};return t&&-1===u&&(d.onDragover=le,d.onDragleave=ie,d.onDrop=ue),(0,_vue.h)("div",Object.assign({ref:m,class:["vxe-upload--more-popup",{"is--readonly":p,"is--disabled":r,"is--active":i,"show--error":e,"is--drag":a}]},d),s?(0,_vn.getSlotVNs)(s({options:n})):[v?o?(0,_vue.h)(_vue.TransitionGroup,{name:"vxe-upload--drag-list"+(l?"":"-disabled"),tag:"div",class:"vxe-upload--image-more-list"},{default:()=>y(n,!0).concat(I(!0))}):(0,_vue.h)("div",{class:"vxe-upload--image-more-list"},y(n,!0).concat(I(!0))):(0,_vue.h)("div",{class:"vxe-upload--file-more-list"},[w(!0),o?(0,_vue.h)(_vue.TransitionGroup,{name:"vxe-upload--drag-list"+(l?"":"-disabled"),tag:"div",class:"vxe-upload--file-list"},{default:()=>x(n,!1)}):(0,_vue.h)("div",{class:"vxe-upload--file-list"},x(n,!0))]),o?(0,_vue.h)("div",{ref:_,class:"vxe-upload--drag-line"}):(0,_ui.renderEmptyElement)(N),a?(0,_vue.h)("div",{class:"vxe-upload--drag-placeholder"},(0,_ui.getI18n)("vxe.upload.dragPlaceholder")):(0,_ui.renderEmptyElement)(N)])}},onShow(){B.showMorePopup=!0},onHide({$event:e}){B.showMorePopup=!1,e&&R("more-visible",{visible:!1},e)}}),e)&&R("more-visible",{visible:!0},e)},re=(e,t,o)=>{var i,l=B["showMorePopup"],a=g.value,u=m.value,u=l?u:a;u&&(a=u.getBoundingClientRect(),u=c.value,i=_.value,l=l?i:u)&&(i=t.getBoundingClientRect(),l.style.display="block",l.style.top=Math.max(1,i.y-a.y)+"px",l.style.left=Math.max(1,i.x-a.x)+"px",l.style.height=i.height+"px",l.style.width=i.width-1+"px",l.setAttribute("drag-pos",o))},se=()=>{var e=c.value,t=_.value;e&&(e.style.display=""),t&&(t.style.display="")},de=e=>{e.stopPropagation(),e.dataTransfer&&e.dataTransfer.setDragImage((0,_dom.getTpImg)(),0,0);const t=e.currentTarget;e=t.parentElement,e=_xeUtils.default.findIndexOf(Array.from(e.children),e=>t===e);B.isDragMove=!0,B.dragIndex=e,setTimeout(()=>{B.isDragMove=!1},500)},pe=t=>{t.stopPropagation(),t.preventDefault();var o=B["dragIndex"];if(-1!==o){var i=f.value;const a=t.currentTarget;var l=a.parentElement,l=_xeUtils.default.findIndexOf(Array.from(l.children),e=>a===e);let e="";e=i?t.clientX-a.getBoundingClientRect().x<a.clientWidth/2?"left":"right":t.clientY-a.getBoundingClientRect().y<a.clientHeight/2?"top":"bottom",o===l?re(t,a,e):(re(t,a,e),r.prevDragIndex=l,r.prevDragPos=e)}},ve=e=>{var{fileList:t,dragIndex:o}=B,{prevDragIndex:i,prevDragPos:l}=r,a="bottom"===l||"right"===l?1:0,u=t[o];const n=t[i];u&&n&&(t.splice(o,1),i=_xeUtils.default.findIndexOf(t,e=>n===e)+a,t.splice(i,0,u),R("sort-dragend",{oldItem:u,newItem:n,dragPos:l,offsetIndex:a,_index:{newIndex:i,oldIndex:o}},e)),se(),B.dragIndex=-1},ge=e=>{i&&e.stopPropagation(),B.isActivated=!0},me=e=>{var t=S["pasteToUpload"],o=B["isActivated"];o&&t&&(o=e.clipboardData||e.originalEvent.clipboardData)&&(t=o["items"],t)&&(o=ne(t)).length&&(e.preventDefault(),ae(e,o))},ce=e=>{var t=g.value,o=m.value;let i=(0,_dom.getEventTargetNode)(e,t).flag;!i&&o&&(o=(t=o.parentElement||o)&&t.parentElement,i=(0,_dom.getEventTargetNode)(e,o).flag),B.isActivated=i},_e=()=>{B.isActivated=!1};t={dispatchEvent:R,choose(){return p(null)},submit(i){var e=S["maxSimultaneousUploads"],e=_xeUtils.default.toNumber(e||1)||1;const{fileList:t,fileCacheMaps:l}=B,o=t.filter(e=>{e=k(e),e=l[e];return e&&("pending"===e.status||i&&"error"===e.status)}),a=e=>{var t=k(e),t=l[t];if(t){var o=t.file;if(o&&("pending"===t.status||i&&"error"===t.status))return t.loading=!0,t.percent=0,G(e,o).then(u)}return u()},u=()=>{var e;return o.length?(e=o[0],o.splice(0,1),a(e).then(u)):Promise.resolve()};return Promise.all(o.splice(0,e).map(a)).then(()=>{})},getMoreVisible(){return B.showMorePopup},openMore(){return h({$event:new Event("click")}),(0,_vue.nextTick)()},openMoreByEvent(e){return h({$event:e}),(0,_vue.nextTick)()},closeMore(){return _ui.VxeUI.modal&&_ui.VxeUI.modal.close(r.moreId),(0,_vue.nextTick)()}};Object.assign(N,t,{});const x=(e,r)=>{const{showRemoveButton:s,showDownloadButton:d,showProgress:p,progressText:v,showPreview:g,showErrorStatus:m,dragSort:c,autoSubmit:_,showSubmitButton:f}=S,{fileList:h,fileCacheMaps:x}=B,w=P.value,y=L.value,I=V.value,b=A.value,C=D.option,U=D.action,E=D.corner,M=D.name,T={};return c&&1<e.length&&(T.onDragstart=de,T.onDragover=pe,T.onDragend=ve),e.map((l,t)=>{var e=k(l),o=x[e];let i=!1,a=!1,u=!1;var n=""+(l[I]||"");return o&&(i=o.loading,a="error"===o.status,u="pending"===o.status),(0,_vue.h)("div",Object.assign({key:c?e:t,class:["vxe-upload--file-item",{"is--preview":g,"is--loading":i,"is--pending":u,"is--error":a}],fileid:e,draggable:!!c||null},T),C?(0,_vn.getSlotVNs)(C({option:l,isMoreView:r,options:h})):[(0,_vue.h)("div",{class:"vxe-upload--file-item-icon"},[(0,_vue.h)("i",{class:(0,_ui.getIcon)()["UPLOAD_FILE_TYPE_"+(""+l[b]).toLocaleUpperCase()]||(0,_ui.getIcon)().UPLOAD_FILE_TYPE_DEFAULT})]),(0,_vue.h)("div",{class:"vxe-upload--file-item-name",title:n,onClick(e){var t,o;i||a||(t=l,o=S.previewMethod||(0,_ui.getConfig)().upload.previewMethod,S.showPreview&&(o?o({$upload:N,option:t}):J(t)))}},M?(0,_vn.getSlotVNs)(M({option:l,isMoreView:r,options:h})):n),i?(0,_vue.h)("div",{class:"vxe-upload--file-item-loading-icon"},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_LOADING})]):(0,_ui.renderEmptyElement)(N),p&&i&&o?(0,_vue.h)("div",{class:"vxe-upload--file-item-loading-text"},v?_xeUtils.default.toFormatString(""+(_xeUtils.default.isFunction(v)?v({}):v),{percent:o.percent}):(0,_ui.getI18n)("vxe.upload.uploadProgress",[o.percent])):(0,_ui.renderEmptyElement)(N),!i&&(a&&m||u&&f&&!_)?(0,_vue.h)("div",{class:"vxe-upload--file-item-rebtn"},[(0,_vue.h)(_button.default,{icon:a?(0,_ui.getIcon)().UPLOAD_IMAGE_RE_UPLOAD:(0,_ui.getIcon)().UPLOAD_IMAGE_UPLOAD,mode:"text",status:"primary",content:a?(0,_ui.getI18n)("vxe.upload.reUpload"):(0,_ui.getI18n)("vxe.upload.manualUpload"),onClick(){Z(l)}})]):(0,_ui.renderEmptyElement)(N),(0,_vue.h)("div",{class:"vxe-upload--file-item-btn-wrapper"},U?(0,_vn.getSlotVNs)(U({option:l,isMoreView:r,options:h,readonly:y})):[E?(0,_vue.h)("div",{class:"vxe-upload--file-item-action"},(0,_vn.getSlotVNs)(E({option:l,isMoreView:r,options:h,readonly:y}))):(0,_ui.renderEmptyElement)(N),!d||i||u?(0,_ui.renderEmptyElement)(N):(0,_vue.h)("div",{class:"vxe-upload--file-item-download-btn",onClick(e){{var t=e,o=l;e=S.beforeDownloadMethod||(0,_ui.getConfig)().upload.beforeDownloadMethod;const i=S.downloadMethod||(0,_ui.getConfig)().upload.downloadMethod;Promise.resolve(!e||e({$upload:N,option:o})).then(e=>{e?i?Promise.resolve(i({$upload:N,option:o})).then(()=>{oe(t,o)}).catch(e=>e):oe(t,o):R("download-fail",{option:o},t)})}}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_FILE_DOWNLOAD})]),!s||y||w||i?(0,_ui.renderEmptyElement)(N):(0,_vue.h)("div",{class:"vxe-upload--file-item-remove-btn",onClick(e){te(e,l,t)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_FILE_REMOVE})])])])})},w=e=>{var{showUploadButton:t,buttonText:o,buttonIcon:i,showButtonText:l,showButtonIcon:a,autoHiddenButton:u}=S,n=B["fileList"],r=P.value,s=L.value,d=Q.value,p=X.value,v=C.value,g=D.default,m=D.tip||D.hint;return s||!t?(0,_ui.renderEmptyElement)(N):(0,_vue.h)("div",{class:"vxe-upload--file-action"},[u&&v?(0,_ui.renderEmptyElement)(N):(0,_vue.h)("div",{class:"vxe-upload--file-action-btn",onClick:ee},g?(0,_vn.getSlotVNs)(g({isMoreView:e,options:n,$upload:N})):[(0,_vue.h)(_button.default,{class:"vxe-upload--file-action-button",content:e||l?o?""+(_xeUtils.default.isFunction(o)?o({}):o):(0,_ui.getI18n)("vxe.upload.fileBtnText"):"",icon:a?i||(0,_ui.getIcon)().UPLOAD_FILE_ADD:"",disabled:r})]),d&&(p||m)?(0,_vue.h)("div",{class:"vxe-upload--file-action-tip"},m?(0,_vn.getSlotVNs)(m({isMoreView:e,options:n,$upload:N})):""+p):(0,_ui.renderEmptyElement)(N)])},y=(e,l)=>{const{showRemoveButton:r,showProgress:s,progressText:d,showPreview:p,showErrorStatus:v,dragSort:g,autoSubmit:m,showSubmitButton:c}=S,{fileList:_,fileCacheMaps:f}=B,h=P.value,x=L.value,w=a.value,y=W.value,I=D.option,b=D.action,C=D.corner,U={onMousedown:ge};return g&&1<e.length&&(U.onDragstart=de,U.onDragover=pe,U.onDragend=ve),e.map((t,a)=>{var e=k(t),o=f[e];let u=!1,n=!1,i=!1;return o&&(u=o.loading,n="error"===o.status,i="pending"===o.status),(0,_vue.h)("div",Object.assign({key:g?e:a,class:["vxe-upload--image-item",{"is--preview":p,"is--circle":w.circle,"is--loading":u,"is--pending":i,"is--error":n}],fileid:e,draggable:!!g||null},U),I?(0,_vn.getSlotVNs)(I({option:t,isMoreView:l,options:_})):[(0,_vue.h)("div",{class:"vxe-upload--image-item-box",style:l?null:y,onClick(e){if(!u&&!n){var t=a;var o=S["showDownloadButton"];const i=B["fileList"],l=S.beforeDownloadMethod||(0,_ui.getConfig)().upload.beforeDownloadMethod;S.showPreview&&_ui.VxeUI.previewImage&&_ui.VxeUI.previewImage({urlList:i.map(e=>q(e)),activeIndex:t,showDownloadButton:o,beforeDownloadMethod:l?({index:e})=>l({$upload:N,option:i[e]}):void 0})}}},[u&&o?(0,_vue.h)("div",{class:"vxe-upload--image-item-loading"},[(0,_vue.h)("div",{class:"vxe-upload--image-item-loading-icon"},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_LOADING})]),s?(0,_vue.h)("div",{class:"vxe-upload--image-item-loading-text"},d?_xeUtils.default.toFormatString(""+(_xeUtils.default.isFunction(d)?d({}):d),{percent:o.percent}):(0,_ui.getI18n)("vxe.upload.uploadProgress",[o.percent])):(0,_ui.renderEmptyElement)(N)]):(0,_ui.renderEmptyElement)(N),(0,_vue.h)("div",{class:"vxe-upload--image-item-img-wrapper",title:(0,_ui.getI18n)("vxe.upload.viewItemTitle")},[(0,_vue.h)("img",{class:"vxe-upload--image-item-img",src:(e=t,(o=S.getThumbnailUrlMethod||(0,_ui.getConfig)().upload.getThumbnailUrlMethod)?o({$upload:N,option:e}):q(e))})]),!u&&(n&&v||i&&c&&!m)?(0,_vue.h)("div",{class:"vxe-upload--image-item-rebtn"},[(0,_vue.h)(_button.default,{icon:n?(0,_ui.getIcon)().UPLOAD_IMAGE_RE_UPLOAD:(0,_ui.getIcon)().UPLOAD_IMAGE_UPLOAD,mode:"text",status:"primary",content:n?(0,_ui.getI18n)("vxe.upload.reUpload"):(0,_ui.getI18n)("vxe.upload.manualUpload"),onClick(){Z(t)}})]):(0,_ui.renderEmptyElement)(N),(0,_vue.h)("div",{class:"vxe-upload--image-item-btn-wrapper",onClick(e){e.stopPropagation()}},b?(0,_vn.getSlotVNs)(b({option:t,isMoreView:l,options:_,readonly:x})):[C?(0,_vue.h)("div",{class:"vxe-upload--file-item-action"},(0,_vn.getSlotVNs)(C({option:t,isMoreView:l,options:_,readonly:x}))):(0,_ui.renderEmptyElement)(N),!r||x||h||u?(0,_ui.renderEmptyElement)(N):(0,_vue.h)("div",{class:"vxe-upload--image-item-remove-btn",onClick(e){e.stopPropagation(),te(e,t,a)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_IMAGE_REMOVE})])])])])})},I=e=>{var{showUploadButton:t,buttonText:o,buttonIcon:i,showButtonText:l,showButtonIcon:a,autoHiddenButton:u}=S,n=B["fileList"],r=L.value,s=Q.value,d=X.value,p=C.value,v=W.value,g=D.default,m=D.tip||D.hint;return r||!t||u&&p?(0,_ui.renderEmptyElement)(N):(0,_vue.h)("div",{key:"action",class:"vxe-upload--image-action"},[(0,_vue.h)("div",{class:"vxe-upload--image-action-btn",onClick:ee},g?g({isMoreView:e,options:n,$upload:N}):[(0,_vue.h)("div",{class:"vxe-upload--image-action-box",style:e?null:v},[a?(0,_vue.h)("div",{class:"vxe-upload--image-action-icon"},[(0,_vue.h)("i",{class:i||(0,_ui.getIcon)().UPLOAD_IMAGE_ADD})]):(0,_ui.renderEmptyElement)(N),e||l?(0,_vue.h)("div",{class:"vxe-upload--image-action-content"},o?""+(_xeUtils.default.isFunction(o)?o({}):o):(0,_ui.getI18n)("vxe.upload.imgBtnText")):(0,_ui.renderEmptyElement)(N),s&&(d||m)?(0,_vue.h)("div",{class:"vxe-upload--image-action-hint"},m?(0,_vn.getSlotVNs)(m({isMoreView:e,options:n,$upload:N})):""+d):(0,_ui.renderEmptyElement)(N)])])])};const o=(0,_vue.ref)(0);return(0,_vue.watch)(()=>S.modelValue?S.modelValue.length:0,()=>{o.value++}),(0,_vue.watch)(()=>S.modelValue,()=>{o.value++}),(0,_vue.watch)(o,()=>{s()}),(0,_vue.onMounted)(()=>{S.multiple&&S.singleMode&&(0,_log.errLog)("vxe.error.errConflicts",["[upload] multiple","single-mode"]),S.imageStyle&&(0,_log.warnLog)("vxe.error.delProp",["[upload] image-style","image-config"]),S.dragSort&&(0,_dom.initTpImg)(),_ui.globalEvents.on(N,"paste",me),_ui.globalEvents.on(N,"mousedown",ce),_ui.globalEvents.on(N,"blur",_e)}),(0,_vue.onUnmounted)(()=>{B.isDragUploadStatus=!1,_ui.globalEvents.off(N,"paste"),_ui.globalEvents.off(N,"mousedown"),_ui.globalEvents.off(N,"blur")}),s(),N.renderVN=()=>{var{showErrorStatus:e,dragToUpload:t,pasteToUpload:o,dragSort:i}=S,{isDragUploadStatus:l,showMorePopup:a,isActivated:u,dragIndex:n}=B,r=b.value,s=P.value,d=L.value,p=f.value,v={onMousedown:ge};return t&&-1===n&&(v.onDragover=le,v.onDragleave=ie,v.onDrop=ue),(0,_vue.h)("div",Object.assign({ref:g,class:["vxe-upload",{["size--"+r]:r,"is--active":u,"is--readonly":d,"is--disabled":s,"is--paste":o,"show--error":e,"is--drag":l}]},v),[(p?()=>{var{showList:e,dragSort:t}=S;const{fileList:o,isDragMove:i}=B;var l=K.value;const a=D.moreButton||D["more-button"],{maxCount:u,showMoreButton:n}=l;let r=o,s=0;return u&&o.length>u&&(s=o.length-u,r=o.slice(0,u)),(0,_vue.h)("div",{key:"image",class:"vxe-upload--image-wrapper"},e?[t?(0,_vue.h)(_vue.TransitionGroup,{name:"vxe-upload--drag-list"+(i?"":"-disabled"),tag:"div",class:"vxe-upload--image-list"},{default:()=>y(r,!1).concat([n&&s?(0,_vue.h)("div",{key:"om",class:"vxe-upload--image-over-more"},a?(0,_vn.getSlotVNs)(a({options:o})):[(0,_vue.h)(_button.default,{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[o.length]),status:"primary",onClick:h})]):(0,_ui.renderEmptyElement)(N),I(!1)])}):(0,_vue.h)("div",{class:"vxe-upload--image-list"},y(r,!1).concat([n&&s?(0,_vue.h)("div",{class:"vxe-upload--image-over-more"},a?(0,_vn.getSlotVNs)(a({options:o})):[(0,_vue.h)(_button.default,{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[o.length]),status:"primary",onClick:h})]):(0,_ui.renderEmptyElement)(N),I(!1)]))]:[(0,_vue.h)("div",{class:"vxe-upload--image-list"},[I(!1)])])}:()=>{var{showList:e,moreConfig:t,dragSort:o}=S,{fileList:i,isDragMove:l}=B,{maxCount:a,showMoreButton:u,layout:n}=K.value,n="horizontal"===n,r=D.moreButton||D["more-button"];let s=i,d=0;return a&&i.length>a&&(d=i.length-a,s=i.slice(0,a)),(0,_vue.h)("div",{key:"all",class:"vxe-upload--file-wrapper"},e?[u&&t&&n?(0,_ui.renderEmptyElement)(N):w(!0),s.length||u&&n?(0,_vue.h)("div",{class:["vxe-upload--file-list-wrapper",{"is--horizontal":n}]},[s.length?o?(0,_vue.h)(_vue.TransitionGroup,{name:"vxe-upload--drag-list"+(l?"":"-disabled"),tag:"div",class:"vxe-upload--file-list"},{default:()=>x(s,!1)}):(0,_vue.h)("div",{class:"vxe-upload--file-list"},x(s,!1)):(0,_ui.renderEmptyElement)(N),u&&d?(0,_vue.h)("div",{class:"vxe-upload--file-over-more"},r?(0,_vn.getSlotVNs)(r({options:i})):[(0,_vue.h)(_button.default,{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[i.length]),status:"primary",onClick:h})]):(0,_ui.renderEmptyElement)(N),u&&t&&n?w(!1):(0,_ui.renderEmptyElement)(N)]):(0,_ui.renderEmptyElement)(N)]:[w(!1)])})(),i?(0,_vue.h)("div",{ref:c,class:"vxe-upload--drag-line"}):(0,_ui.renderEmptyElement)(N),l&&!a?(0,_vue.h)("div",{class:"vxe-upload--drag-placeholder"},(0,_ui.getI18n)("vxe.upload.dragPlaceholder")):(0,_ui.renderEmptyElement)(N)])},N},render(){return this.renderVN()}});