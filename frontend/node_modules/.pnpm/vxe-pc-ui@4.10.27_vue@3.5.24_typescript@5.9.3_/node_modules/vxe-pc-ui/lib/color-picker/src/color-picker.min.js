"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_util=require("./util"),_button=_interopRequireDefault(require("../../button/src/button")),_input=_interopRequireDefault(require("../../input/src/input")),_numberInput=_interopRequireDefault(require("../../number-input/src/number-input"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_comp.defineVxeComponent)({name:"VxeColorPicker",props:{modelValue:String,placeholder:String,clearable:{type:Boolean,default:()=>(0,_ui.getConfig)().colorPicker.clearable},type:{type:String,default:()=>(0,_ui.getConfig)().colorPicker.type},size:{type:String,default:()=>(0,_ui.getConfig)().colorPicker.size||(0,_ui.getConfig)().size},className:[String,Function],popupClassName:[String,Function],colors:{type:Array,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().colorPicker.colors,!0)||[]},showAlpha:{type:Boolean,default:()=>(0,_ui.getConfig)().colorPicker.showAlpha},showEyeDropper:{type:Boolean,default:()=>(0,_ui.getConfig)().colorPicker.showEyeDropper},showColorExtractor:{type:Boolean,default:()=>(0,_ui.getConfig)().colorPicker.showColorExtractor},showQuick:{type:Boolean,default:()=>(0,_ui.getConfig)().colorPicker.showQuick},readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},clickToCopy:{type:Boolean,default:()=>(0,_ui.getConfig)().colorPicker.clickToCopy},placement:String,transfer:{type:Boolean,default:null}},emits:["update:modelValue","change","clear","click"],setup(_,e){const t=e["emit"],D=(0,_vue.inject)("$xeModal",null),M=(0,_vue.inject)("$xeDrawer",null),O=(0,_vue.inject)("$xeTable",null),i=(0,_vue.inject)("$xeForm",null),a=(0,_vue.inject)("xeFormItemInfo",null),h="undefined"!=typeof window?window.EyeDropper:null;var l=_xeUtils.default.uniqueId();const S=(0,_ui.useSize)(_)["computeSize"],v=(0,_vue.ref)(),p=(0,_vue.ref)(),d=(0,_vue.ref)(),m=(0,_vue.ref)(),g=(0,_vue.ref)(),x=(0,_vue.ref)(),f=(0,_vue.ref)(),b=(0,_vue.ref)(),k=(0,_vue.ref)(),C=(0,_vue.reactive)({initialized:!1,selectTyle:"hex",selectColor:""+(_.modelValue||""),showTypePopup:!1,panelColor:"",hexValue:"",rValue:0,gValue:0,bValue:0,aValue:0,panelIndex:0,panelStyle:{},panelPlacement:null,visiblePanel:!1,isAniVisible:!1,isActivated:!1}),y=[{label:"HEX",value:"hex"},{label:"RGB",value:"rgb"}],o={},L=(0,_vue.computed)(()=>{var e=_["readonly"];return null===e?!!i&&i.props.readonly:e}),V=(0,_vue.computed)(()=>{var e=_["disabled"];return null===e?!!i&&i.props.disabled:e}),w=(0,_vue.computed)(()=>{var e=_["transfer"];if(null===e){var l=(0,_ui.getConfig)().colorPicker.transfer;if(_xeUtils.default.isBoolean(l))return l;if(O||D||M||i)return!0}return e}),N=(0,_vue.computed)(()=>{var e=_["colors"];return e?e.map(e=>_xeUtils.default.isString(e)?{label:e,value:e}:{label:_xeUtils.default.eqNull(e.label)?e.value:e.label,value:e.value}):[]}),P=(0,_vue.computed)(()=>{var e=C["selectTyle"];return"rgb"===e}),H=(0,_vue.computed)(()=>{const l=C["selectTyle"];return y.find(e=>e.value===l)}),$={refElem:v},j={},E={xID:l,props:_,context:e,reactData:C,getRefMaps:()=>$,getComputeMaps:()=>j},r=()=>{var e=_["modelValue"];C.selectColor=_xeUtils.default.toValueString(e),T()},u=()=>{var e=_["type"];let l="rgb"!==e&&"rgba"!==e?"hex":"rgb";C.selectTyle=l,r()},T=()=>{var e,{selectColor:l,isAniVisible:o}=C,t=P.value,i=m.value,a=x.value,l=(0,_util.parseColor)(l);C.hexValue=l.hex,C.rValue=l.r,C.gValue=l.g,C.bValue=l.b,C.aValue=l.a,l.value&&(t?"hex"===l.type&&(t=(0,_util.hexToRgb)(l.hex))&&(C.rValue=t.r,C.gValue=t.g,C.bValue=t.b,C.aValue=t.a):"hex"!==l.type&&(C.hexValue=(0,_util.rgbToHex)(l))),o&&(t="hex"===l.type?(0,_util.hexToHsv)(l.hex):(0,_util.rgbToHsv)(l),o=b.value,t&&(o&&(e=o.clientHeight*(1-t.v),o=o.clientWidth*t.s,ae(o,e)),i)&&R(_xeUtils.default.ceil((1-t.h/360)*i.clientWidth)),a)&&B(a.clientWidth*l.a)},n=()=>{const o=_["placement"],t=C["panelIndex"],i=v.value,a=d.value,r=w.value;var e=()=>{var e=(0,_dom.updatePanelPlacement)(i,a,{placement:o,teleportTo:r}),l=Object.assign(e.style,{zIndex:t});C.panelStyle=l,C.panelPlacement=e.placement};return e(),(0,_vue.nextTick)().then(e)},c=()=>{var e=o["hpTimeout"];V.value||(e&&(clearTimeout(e),o.hpTimeout=void 0),C.initialized||(C.initialized=!0),C.isActivated=!0,C.isAniVisible=!0,setTimeout(()=>{T(),C.visiblePanel=!0},10),C.panelIndex<(0,_utils.getLastZIndex)()&&(C.panelIndex=(0,_utils.nextZIndex)()),n())},s=()=>{C.visiblePanel=!1,o.hpTimeout=setTimeout(()=>{C.isAniVisible=!1},350)},I=(e,l)=>{var o;(C.selectColor=l)!==_.modelValue&&(o=l,t("update:modelValue",o),q("change",{value:l},e),i)&&a&&i.triggerItemEvent(e,a.itemConfig.field,l)},F=(e,l)=>{I(e,l),q("clear",{value:l},e)},W=()=>{V.value||C.visiblePanel||c()},Y=()=>{C.isActivated=!1},X=e=>{F(e,null),s()},G=e=>{var l=C["selectColor"];I(e,l),s()},K=e=>{e.preventDefault(),(C.visiblePanel?s:c)()},Q=e=>{K(e),q("click",{},e)},Z=()=>{C.showTypePopup=!1},J=e=>{e.stopPropagation(),C.showTypePopup=!C.showTypePopup},ee=e=>{var l=C["selectTyle"];e!==l&&(C.selectTyle=e,T()),C.showTypePopup=!1},R=t=>{var i=m.value,a=g.value;if(i&&a){t<0&&(t=0);var i=_xeUtils.default.toInteger(i.clientWidth),r=255,i=_xeUtils.default.ceil(1530/i*t),u=i%r;let e=0,l=0,o=0;switch(Math.ceil(i/r)){case 1:e=r,o=u;break;case 2:e=r-u,o=r;break;case 3:l=u,o=r;break;case 4:l=r,o=r-u;break;case 5:e=u,l=r;break;case 6:e=r,l=r-u}C.panelColor=(0,_util.toRgb)(e,l,o),a.style.left=(0,_dom.toCssUnit)(t)}},U=e=>{var l=m.value,o=g.value;l&&o&&(o=l.getBoundingClientRect(),l=_xeUtils.default.toInteger(l.clientWidth),l=_xeUtils.default.ceil(Math.min(l-1,Math.max(1,e.clientX-o.x))),R(l))},le=e=>{e.preventDefault(),document.onmousemove=e=>{e.preventDefault(),U(e)},document.onmouseup=e=>{document.onmousemove=null,document.onmouseup=null,U(e)}},B=e=>{var l=C["selectColor"],o=x.value,t=f.value;o&&t&&(o=o.getBoundingClientRect().width,o=_xeUtils.default.ceil(100/o*(e=o<(e=e<0?0:e)?o:e)/100,2),C.aValue=o,t.style.left=(0,_dom.toCssUnit)(e),C.selectColor=(0,_util.updateColorAlpha)(l,o))},z=e=>{var l=x.value,o=f.value;l&&o&&(l=(o=l.getBoundingClientRect()).width,l=Math.min(l,Math.max(0,e.clientX-o.x)),B(l),T())},oe=e=>{e.preventDefault(),document.onmousemove=e=>{e.preventDefault(),z(e)},document.onmouseup=e=>{document.onmousemove=null,document.onmouseup=null,z(e)}},A=()=>{var{rValue:e,gValue:l,bValue:o,aValue:t}=C;C.selectColor=(0,_util.toRgb)(e,l,o,t),T()},te=()=>{var e=C["aValue"],l=x.value,o=f.value;l&&o&&(o=l.getBoundingClientRect().width*e,B(o))},ie=(e,l)=>{l=l.value;C.selectColor=l,T()},ae=(e,l)=>{var o=k.value;o&&(o.style.top=(0,_dom.toCssUnit)(l),o.style.left=(0,_dom.toCssUnit)(e))},re=()=>{if(h)try{(new h).open().then(e=>{e&&e.sRGBHex&&(C.selectColor=e.sRGBHex,T())}).catch(()=>{})}catch(e){}},ue=(e,l)=>{var o,t=_["showAlpha"],{panelColor:i,aValue:a}=C,r=b.value,u=k.value;r&&u&&({clientWidth:u,clientHeight:o}=r,r=r.getBoundingClientRect(),l=Math.min(o,Math.max(0,l-r.y)),e=Math.min(u,Math.max(0,e-r.x)),(r=(0,_util.parseColor)(i))&&(i="hex"===r.type?(0,_util.hexToHsv)(r.hex):(0,_util.rgbToHsv)(r))&&(r=(0,_util.hsvToRgb)(i.h,e/u,1-l/o),C.selectColor=(0,_util.toRgb)(r.r,r.g,r.b,t?a:null),T()),ae(e,l))},ne=e=>{e.stopPropagation(),e.preventDefault(),ue(e.clientX,e.clientY),document.onmousemove=e=>{ue(e.clientX,e.clientY)},document.onmouseup=()=>{document.onmousemove=null,document.onmouseup=null}},ce=()=>{var e=C["selectColor"];e&&_ui.VxeUI.clipboard.copy(e)&&_ui.VxeUI.modal&&_ui.VxeUI.modal.message({content:(0,_ui.getI18n)("vxe.colorPicker.copySuccess",[e]),status:"success"})},se=e=>{var l=C["visiblePanel"];V.value||l&&(l=d.value,((0,_dom.getEventTargetNode)(e,l).flag?n:s)())},ve=e=>{var l,o,t=C["visiblePanel"];V.value||(l=v.value,o=d.value,C.isActivated=(0,_dom.getEventTargetNode)(e,l).flag||(0,_dom.getEventTargetNode)(e,o).flag,t&&!C.isActivated&&s())},pe=()=>{var{visiblePanel:e,isActivated:l}=C;e&&s(),l&&(C.isActivated=!1),(e||l)&&(e=p.value)&&e.blur()},de=()=>{var e=C["visiblePanel"];e&&n()},q=(e,l,o)=>{t(e,(0,_ui.createEvent)(o,{$colorPicker:E},l))};l={dispatchEvent:q};Object.assign(E,l,{});return(0,_vue.watch)(()=>_.modelValue,()=>{r()}),(0,_vue.watch)(()=>_.type,()=>{u()}),(0,_vue.onMounted)(()=>{_ui.globalEvents.on(E,"mousewheel",se),_ui.globalEvents.on(E,"mousedown",ve),_ui.globalEvents.on(E,"blur",pe),_ui.globalEvents.on(E,"resize",de)}),(0,_vue.onUnmounted)(()=>{_ui.globalEvents.off(E,"mousewheel"),_ui.globalEvents.off(E,"mousedown"),_ui.globalEvents.off(E,"blur"),_ui.globalEvents.off(E,"resize")}),u(),(0,_vue.provide)("$xeColorPicker",E),E.renderVN=()=>{var{className:e,popupClassName:l,clearable:o,modelValue:t}=_,{initialized:i,isActivated:a,isAniVisible:r,visiblePanel:u}=C,n=S.value,c=V.value,s=w.value;return L.value?(0,_vue.h)("div",{ref:v,class:["vxe-color-picker--readonly",e]},[(0,_vue.h)("div",{class:"vxe-color-picker--readonly-color",style:{backgroundColor:t}})]):(0,_vue.h)("div",{ref:v,class:["vxe-color-picker",e?_xeUtils.default.isFunction(e)?e({$colorPicker:E}):e:"",{["size--"+n]:n,"is--selected":!!t,"is--visible":u,"is--disabled":c,"is--active":a}]},[(0,_vue.h)("input",{ref:p,class:"vxe-color-picker--input",onFocus:W,onBlur:Y}),(0,_vue.h)("div",{class:"vxe-color-picker--inner",onClick:Q},[(0,_vue.h)("div",{class:"vxe-color-picker--inner-color",style:{backgroundColor:t}})]),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!s||!i},[(0,_vue.h)("div",{ref:d,class:["vxe-table--ignore-clear vxe-color-picker--panel",l?_xeUtils.default.isFunction(l)?l({$colorPicker:E}):l:"",{["size--"+n]:n,"is--transfer":s,"ani--leave":r,"ani--enter":u}],placement:C.panelPlacement,style:C.panelStyle},[i&&(u||r)?(0,_vue.h)("div",{class:"vxe-color-picker--panel-wrapper",onClick:Z},[(e=_.showColorExtractor,c=C.panelColor,e?(0,_vue.h)("div",{ref:b,class:"vxe-color-picker--color-wrapper",onMousedown:ne},[(0,_vue.h)("div",{class:"vxe-color-picker--color-bg",style:{backgroundColor:c}}),(0,_vue.h)("div",{class:"vxe-color-picker--white-bg"}),(0,_vue.h)("div",{class:"vxe-color-picker--black-bg"}),(0,_vue.h)("div",{ref:k,class:"vxe-color-picker--color-active"})]):(0,_ui.renderEmptyElement)(E)),(()=>{var{showAlpha:e,clickToCopy:l,showEyeDropper:o}=_,{selectTyle:t,showTypePopup:i,hexValue:a,rValue:r,gValue:u,bValue:n,aValue:c,selectColor:s,panelColor:v}=C,p=P.value,d=H.value;return(0,_vue.h)("div",{class:"vxe-color-picker--bar-wrapper"},[(0,_vue.h)("div",{class:"vxe-color-picker--slider-wrapper"},[o&&h?(0,_vue.h)("div",{class:"vxe-color-picker--color-dropper"},[(0,_vue.h)("span",{class:"vxe-color-picker--color-dropper-btn",onClick:re},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().COLOR_PICKER_EYE_DROPPER})])]):(0,_ui.renderEmptyElement)(E),(0,_vue.h)("div",{class:"vxe-color-picker--slider-preview"},[(0,_vue.h)("div",{class:"vxe-color-picker--preview-btn"},[(0,_vue.h)("div",{class:"vxe-color-picker--preview-color",style:{backgroundColor:s}},l?[(0,_vue.h)("span",{class:"vxe-color-picker--preview-copy-btn",onClick:ce},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().COLOR_PICKER_COLOR_COPY})])]:[])])]),(0,_vue.h)("div",{class:"vxe-color-picker--slider-handle"},[(0,_vue.h)("div",{ref:m,class:"vxe-color-picker--bar-hue-slider",onClick:U},[(0,_vue.h)("div",{ref:g,class:"vxe-color-picker--bar-hue-btn",onMousedown:le})]),e?(0,_vue.h)("div",{ref:x,class:"vxe-color-picker--bar-alpha-slider",onClick:z},[(0,_vue.h)("div",{class:"vxe-color-picker--bar-alpha-bg",style:{background:`linear-gradient(to right, rgba(0, 0, 0, 0), ${v})`}}),(0,_vue.h)("div",{ref:f,class:"vxe-color-picker--bar-alpha-btn",onMousedown:oe})]):(0,_ui.renderEmptyElement)(E)])]),(0,_vue.h)("div",{class:"vxe-color-picker--custom-wrapper"},[(0,_vue.h)("div",{class:"vxe-color-picker--type-switch"},[(0,_vue.h)("div",{class:"vxe-color-picker--type-label",onClick:J},[(0,_vue.h)("span",""+(d?d.label:t)),(0,_vue.h)("span",{class:"vxe-color-picker--type-icon"},[(0,_vue.h)("i",{class:i?(0,_ui.getIcon)().COLOR_PICKER_TPTY_OPEN:(0,_ui.getIcon)().COLOR_PICKER_TPTY_CLOSE})])]),(0,_vue.h)("div",{class:["vxe-color-picker--type-popup",{"is--visible":i}]},y.map(l=>(0,_vue.h)("div",{class:"vxe-color-picker--type-item",onClick(e){e.stopPropagation(),ee(l.value)}},l.label)))]),(0,_vue.h)("div",{class:`vxe-color-picker--${t}-wrapper`},p?[(0,_vue.h)("div",{class:"vxe-color-picker--input-wrapper"},[(0,_vue.h)(_numberInput.default,{type:"integer",size:"mini",align:"center",min:0,max:255,maxLength:3,placeholder:"",modelValue:r,controlConfig:{showButton:!1},"onUpdate:modelValue"(e){C.rValue=e},onChange:A}),(0,_vue.h)(_numberInput.default,{type:"integer",size:"mini",align:"center",min:0,max:255,maxLength:3,placeholder:"",modelValue:u,controlConfig:{showButton:!1},"onUpdate:modelValue"(e){C.gValue=e},onChange:A}),(0,_vue.h)(_numberInput.default,{type:"integer",size:"mini",align:"center",min:0,max:255,maxLength:3,placeholder:"",modelValue:n,controlConfig:{showButton:!1},"onUpdate:modelValue"(e){C.bValue=e},onChange:A}),(0,_vue.h)(_numberInput.default,{type:"number",size:"mini",align:"center",min:0,max:1,step:.01,maxLength:4,placeholder:"",modelValue:c,controlConfig:{showButton:!1},"onUpdate:modelValue"(e){C.aValue=e},onChange:te})]),(0,_vue.h)("div",{class:"vxe-color-picker--input-title"},[(0,_vue.h)("span","R"),(0,_vue.h)("span","G"),(0,_vue.h)("span","B"),(0,_vue.h)("span","A")])]:[(0,_vue.h)("div",{class:"vxe-color-picker--input-wrapper"},[(0,_vue.h)(_input.default,{type:"text",size:"mini",align:"center",maxLength:9,placeholder:"",modelValue:a,"onUpdate:modelValue"(e){C.hexValue=e},onChange(){var e=(0,_util.parseColor)(C.hexValue);e&&e.value&&(C.selectColor=e.value,T())}})]),(0,_vue.h)("div",{class:"vxe-color-picker--input-title"},(0,_ui.getI18n)("vxe.colorPicker.hex"))])])])})(),(a=_.showQuick,t=N.value,a&&t.length?(0,_vue.h)("div",{class:"vxe-color-picker--quick-wrapper"},t.map((l,e)=>(0,_vue.h)("div",{key:e,class:"vxe-color-picker--quick-item",title:l.label||"",style:{backgroundColor:l.value},onClick(e){ie(e,l)}}))):(0,_ui.renderEmptyElement)(E)),(0,_vue.h)("div",{class:"vxe-color-picker--footer-wrapper"},[o?(0,_vue.h)(_button.default,{content:(0,_ui.getI18n)("vxe.colorPicker.clear"),size:"mini",onClick:X}):(0,_ui.renderEmptyElement)(E),(0,_vue.h)(_button.default,{content:(0,_ui.getI18n)("vxe.colorPicker.confirm"),size:"mini",status:"primary",onClick:G})])]):(0,_ui.renderEmptyElement)(E)])])])},E},render(){return this.renderVN()}});